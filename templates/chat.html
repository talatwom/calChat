<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت‌بات تقویم</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>

<div class="chat-container">
    <div class="chat-header">چت‌بات تقویم</div>
    <div class="chat-box" id="chat-box">
        <!-- پیام‌ها در اینجا قرار می‌گیرند -->
    </div>
    <div class="input-container">
        <textarea id="user-input" placeholder="چی می‌خوای به تقویمت اضافه کنی؟..." rows="2"></textarea>
        <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-rocket" style="transform: rotate(-45deg);"></i></button> <!-- تغییر آیکون -->
    </div>
</div>

<script>
    function formatTime() {
        var date = new Date();
        return date.getHours() + ":" + date.getMinutes();
    }

    function sendMessage() {
        var userInput = document.getElementById("user-input").value;
        var chatBox = document.getElementById("chat-box");

        if (userInput.trim() === "") {
            return;
        }

        // نمایش پیام کاربر
        chatBox.innerHTML += "<div class='message user'>" + userInput + " <span class='time'>" + formatTime() + "</span></div>";

        // پاک کردن ورودی کاربر
        document.getElementById("user-input").value = "";

        // اسکرول به پایین
        chatBox.scrollTop = chatBox.scrollHeight;

        // نمایش انیمیشن لودینگ
        chatBox.innerHTML += "<div class='message bot loading'><span>در حال پردازش...</span><i class='fas fa-circle-notch'></i></div>";
        chatBox.scrollTop = chatBox.scrollHeight;

        // ارسال پیام به سرور
        fetch("/ask", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "user_input=" + encodeURIComponent(userInput)
        })
        .then(response => response.json())
        .then(data => {
            // حذف انیمیشن لودینگ
            var loadingMessage = document.querySelector(".loading");
            loadingMessage.remove();

            // نمایش پاسخ چت‌بات
            chatBox.innerHTML += "<div class='message bot'>" + data.response + "<button class='add-event-btn' onclick='addEventToGoogleCalendar()'>اضافه کردن رویداد به تقویم</button> <span class='time'>" + formatTime() + "</span></div>";
            chatBox.scrollTop = chatBox.scrollHeight;  // اسکرول به پایین
        });
    }

    // افزودن عملکرد ارسال با دکمه Enter
    document.getElementById("user-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    // تابع جاوا اسکریپت برای ارسال رویداد به گوگل کلندر
    function addEventToGoogleCalendar() {
        fetch("/add_event_from_json", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ file: 'event_details.json' })  // ارسال فایل JSON به سرور
        })
        .then(response => response.json())  // دریافت پاسخ از سرور
        .then(data => {
            alert(data.message);  // نمایش پیام از سرور (موفقیت یا خطا)
        })
        .catch(error => {
            console.error("Error:", error);  // در صورت بروز خطا در ارسال درخواست
        });
    }
</script>

</body>
</html>
